input {
    udp {
        type => "nginx_log"
        buffer_size => 4096
        port => 10000
    }
    udp {
        type => "balancer_log"
        buffer_size => 4096
        port => 10001
    }
    udp {
        type => "app_log"
        buffer_size => 4096
        port => 10002
    }
}

filter {
    if [type] == "balancer_log" {
        drop { }
    } else {
        grok {
            patterns_dir => ["/usr/share/logstash/config/patterns"]
            match => {
                "message" => [
                    "%{NGX_REQ_ID:rid} %{IPORHOST:src} \[%{HTTPDATE:ts}\] \"%{WORD:verb} %{URIPATHPARAM:request} HTTP/%{NUMBER:httpversion}\" %{NUMBER:response}",
                    "%{NGX_REQ_ID:rid} %{PYTHON_TIMESTAMP:ts} %{APP_NAME:app} \[%{PYTHON_LOG_LEVEL:level}\] %{GREEDYDATA:msg}"
                ]
            }
        }        
    }
    date {
        match => ["ts" , "dd/MMM/yyyy:HH:mm:ss Z", "yyyy-MM-dd HH:mm:ss,SSS"]
        target => "ts"
    }
}

output {
    stdout { }

    if [type] == "nginx_log" {
        elasticsearch {
            hosts => "elasticsearch:9200"
            index => "access-%{+YYYY.MM.dd}"
        }
    } else {
        elasticsearch {
            hosts => "elasticsearch:9200"
            index => "unknown-%{+YYYY.MM.dd}"
        }
    }
}
